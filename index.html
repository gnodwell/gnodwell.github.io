<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Study Questions</title>
    <style>
      :root {
        --bg: #f4f6f8;
        --card: #fff;
        --ink: #111;
        --muted: #58606a;
        --line: #e6e9ee;
        --soft: #f7f9fb;
        --soft2: #e9eef3;
        --good: #137333;
        --bad: #b00020;
      }
      body {
        font-family: Arial, Helvetica, sans-serif;
        background: var(--bg);
        margin: 0;
        padding: 20px;
        color: var(--ink);
      }
      header {
        max-width: 980px;
        margin: 0 auto 18px;
      }
      h1 {
        margin: 0 0 6px;
      }
      .sub {
        margin: 0;
        color: var(--muted);
      }

      .wrap {
        max-width: 980px;
        margin: 0 auto;
        background: var(--card);
        border-radius: 12px;
        padding: 18px;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
      }

      .divider {
        height: 1px;
        background: var(--line);
        margin: 14px 0;
      }

      .topbar {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
        margin-bottom: 12px;
      }

      .btn {
        border: 0;
        border-radius: 10px;
        padding: 10px 12px;
        cursor: pointer;
        font-weight: 900;
        background: var(--soft2);
      }
      .btn:hover {
        filter: brightness(0.97);
      }
      .btn.primary {
        background: #d6e3f3;
      }
      .btn.small {
        padding: 8px 10px;
        font-weight: 800;
      }
      .btn.selected {
        outline: 3px solid #bcd2f7;
      }

      .pill {
        padding: 10px 12px;
        border-radius: 999px;
        background: #f1f3f5;
        font-weight: 900;
      }
      .pill span {
        font-variant-numeric: tabular-nums;
      }

      .q {
        border: 1px solid var(--line);
        border-radius: 12px;
        padding: 16px;
        margin: 0;
      }
      .q h2 {
        font-size: 1.05rem;
        margin: 0 0 10px;
      }

      .choices {
        display: grid;
        gap: 8px;
        margin-top: 8px;
      }
      label.choice {
        display: flex;
        gap: 10px;
        align-items: flex-start;
        padding: 10px;
        border-radius: 10px;
        background: var(--soft);
        border: 1px solid transparent;
        cursor: pointer;
      }
      label.choice:hover {
        background: #f0f5ff;
        border-color: #d8e2ff;
      }

      input[type="radio"],
      input[type="checkbox"] {
        margin-top: 2px;
      }

      .row {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: flex-end;
        margin-top: 10px;
      }
      select {
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid var(--line);
        background: #fff;
        min-width: 260px;
      }

      .tiny {
        color: var(--muted);
        font-size: 0.92rem;
      }

      .status {
        margin-top: 10px;
        font-weight: 900;
      }
      .good {
        color: var(--good);
      }
      .bad {
        color: var(--bad);
      }
      .explain {
        margin-top: 8px;
        color: var(--muted);
        font-size: 0.92rem;
      }

      .nav {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        justify-content: space-between;
        margin-top: 14px;
      }
      .nav .left,
      .nav .right {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }
      .disabled {
        opacity: 0.45;
        cursor: not-allowed;
      }

      /* Selector UI */
      .selector {
        border: 1px solid var(--line);
        border-radius: 12px;
        padding: 12px;
        background: #fbfcfd;
      }
      .selector h3 {
        margin: 0 0 8px;
        font-size: 1rem;
      }
      .chips {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }
      .metaLine {
        margin-top: 10px;
        color: var(--muted);
        font-size: 0.92rem;
      }
      .warn {
        margin-top: 10px;
        padding: 10px 12px;
        border-radius: 10px;
        background: #fff3cd;
        border: 1px solid #ffe69c;
        color: #6b5600;
        font-weight: 800;
      }
    </style>
  </head>

  <body>
    <header>
      <h1>Study Questions</h1>
    </header>

    <div class="wrap">
      <!-- NEW: Dynamic selectors -->
      <div class="selector">
        <h3>Choose what to study</h3>

        <div class="tiny" style="font-weight: 900; margin-bottom: 6px">
          Subject
        </div>
        <div class="chips" id="subjectChips"></div>

        <!-- <div class="tiny" style="font-weight: 900; margin: 12px 0 6px">
          Topic
        </div>
        <div class="chips" id="topicChips"></div> -->

        <div class="tiny" style="font-weight: 900; margin: 12px 0 6px">
          Lecture
        </div>
        <div class="chips" id="lectureChips"></div>

        <div class="metaLine" id="selectionSummary">No quiz selected yet.</div>

        <div
          style="margin-top: 12px; display: flex; gap: 10px; flex-wrap: wrap"
        >
          <button class="btn primary" id="startBtn" type="button">
            Start Quiz
          </button>
          <button class="btn" id="clearSelectionBtn" type="button">
            Clear Selection
          </button>
        </div>

        <div class="warn" id="noMatchesWarn" style="display: none">
          No questions match this selection. Pick different filters.
        </div>
      </div>

      <div class="divider"></div>

      <div class="topbar">
        <button class="btn" id="resetBtn" type="button">Reset Quiz</button>
        <button class="btn" id="shuffleBtn" type="button">Shuffle Quiz</button>

        <div class="pill">Correct: <span id="correctCount">0</span></div>
        <div class="pill">Wrong: <span id="wrongCount">0</span></div>
        <div class="pill">
          Checked: <span id="checkedCount">0</span> /
          <span id="totalCount">0</span>
        </div>
        <div class="pill">
          Question: <span id="posCount">0</span> /
          <span id="totalCount2">0</span>
        </div>
      </div>

      <div class="divider"></div>

      <div id="questionHost"></div>

      <div class="nav">
        <div class="left">
          <button class="btn" id="prevBtn" type="button">← Prev</button>
          <button class="btn" id="nextBtn" type="button">Next →</button>
        </div>
        <div class="right">
          <button class="btn primary" id="checkBtn" type="button">Check</button>
          <button class="btn" id="checkAllBtn" type="button">
            Check All Answered
          </button>
        </div>
      </div>
    </div>

    <script src="./question-bank.js"></script>


    <script>
        console.log("Question bank loaded:", QUESTIONS.length, "questions");
      // =========================
      // 2) ELEMENTS
      // =========================
      const els = {
        host: document.getElementById("questionHost"),
        correctCount: document.getElementById("correctCount"),
        wrongCount: document.getElementById("wrongCount"),
        checkedCount: document.getElementById("checkedCount"),
        totalCount: document.getElementById("totalCount"),
        totalCount2: document.getElementById("totalCount2"),
        posCount: document.getElementById("posCount"),

        resetBtn: document.getElementById("resetBtn"),
        shuffleBtn: document.getElementById("shuffleBtn"),
        prevBtn: document.getElementById("prevBtn"),
        nextBtn: document.getElementById("nextBtn"),
        checkBtn: document.getElementById("checkBtn"),
        checkAllBtn: document.getElementById("checkAllBtn"),

        subjectChips: document.getElementById("subjectChips"),
        // topicChips: document.getElementById("topicChips"),
        lectureChips: document.getElementById("lectureChips"),
        selectionSummary: document.getElementById("selectionSummary"),
        startBtn: document.getElementById("startBtn"),
        clearSelectionBtn: document.getElementById("clearSelectionBtn"),
        noMatchesWarn: document.getElementById("noMatchesWarn"),
      };

      // =========================
      // 3) STATE
      // =========================
      let activeQuestions = []; // <- filtered quiz lives here

      const state = {
        index: 0,
        checked: {}, // qid -> "right"|"wrong"
        total: 0,
        selectedSubjects: [],
        // selectedTopics: [],
        selectedLectures: [],
        answers: {}, // qid -> user answer (shape depends on type)
      };

      // =========================
      // 4) HELPERS
      // =========================

      function gradeQuestion(q, userAnswer) {
        const isTrueFalse = q.type === "truefalse";
        const type = isTrueFalse ? "single" : q.type;

        if (userAnswer == null) return null; // unanswered

        if (type === "single") {
          if (isTrueFalse) {
            const pickedBool = Number(userAnswer) === 0; // True=0, False=1
            return pickedBool === Boolean(q.answer);
          }
          return Number(userAnswer) === q.answerIndex;
        }

        if (type === "multi") {
          if (!Array.isArray(userAnswer)) return null;
          return arraysEqualAsSets(userAnswer, q.answerIndices);
        }

        if (type === "dropdown") {
          return String(userAnswer) === String(q.answerValue);
        }

        if (type === "double") {
          if (!Array.isArray(userAnswer) || userAnswer.length < 2) return null;
          return (
            userAnswer[0] === q.answers[0] && userAnswer[1] === q.answers[1]
          );
        }

        return null;
      }

      function checkAllAnswered() {
        if (!activeQuestions.length) return;

        let answered = 0,
          correct = 0,
          wrong = 0,
          unanswered = 0;
        const wrongList = [];
        const unansweredList = [];

        for (const q of activeQuestions) {
          const ua = state.answers[q.id];

          const result = gradeQuestion(q, ua);

          if (result === null) {
            unanswered++;
            unansweredList.push(q);
            continue;
          }

          answered++;
          if (result) {
            correct++;
            state.checked[q.id] = "right";
          } else {
            wrong++;
            state.checked[q.id] = "wrong";
            wrongList.push(q);
          }
        }

        // Refresh current screen status + counters
        renderCurrentQuestion();

        showReportModal({
          answered,
          correct,
          wrong,
          unanswered,
          wrongList,
          unansweredList,
        });
      }

      function showReportModal(data) {
        // remove existing modal if any
        const existing = document.getElementById("reportModalOverlay");
        if (existing) existing.remove();

        const overlay = document.createElement("div");
        overlay.id = "reportModalOverlay";
        overlay.style.position = "fixed";
        overlay.style.inset = "0";
        overlay.style.background = "rgba(0,0,0,0.45)";
        overlay.style.display = "grid";
        overlay.style.placeItems = "center";
        overlay.style.padding = "18px";
        overlay.style.zIndex = "9999";

        const modal = document.createElement("div");
        modal.style.width = "min(900px, 100%)";
        modal.style.maxHeight = "80vh";
        modal.style.overflow = "auto";
        modal.style.background = "#fff";
        modal.style.borderRadius = "14px";
        modal.style.boxShadow = "0 10px 30px rgba(0,0,0,0.25)";
        modal.style.padding = "16px";

        const title = document.createElement("div");
        title.style.display = "flex";
        title.style.justifyContent = "space-between";
        title.style.gap = "12px";
        title.style.alignItems = "center";

        title.innerHTML = `
    <div>
      <div style="font-weight:900; font-size:1.1rem;">Session Report</div>
      <div style="color:#58606a; margin-top:4px;">
        Answered: <strong>${data.answered}</strong> • Correct: <strong>${data.correct}</strong> • Wrong: <strong>${data.wrong}</strong> • Unanswered: <strong>${data.unanswered}</strong>
      </div>
    </div>
  `;

        const closeBtn = document.createElement("button");
        closeBtn.className = "btn";
        closeBtn.textContent = "Close";
        closeBtn.addEventListener("click", () => overlay.remove());
        title.appendChild(closeBtn);

        const section = document.createElement("div");
        section.style.marginTop = "14px";

        const wrongHtml = data.wrongList.length
          ? `<div style="font-weight:900; margin:10px 0 6px; color:#b00020;">Wrong (${
              data.wrongList.length
            })</div>
       <ol style="margin:0 0 10px 18px;">
         ${data.wrongList
           .map((q) => `<li style="margin:6px 0;">${escapeHtml(q.prompt)}</li>`)
           .join("")}
       </ol>`
          : `<div style="font-weight:900; margin:10px 0; color:#137333;">No wrong answers ✅</div>`;

        const unHtml = data.unansweredList.length
          ? `<div style="font-weight:900; margin:10px 0 6px;">Unanswered (${
              data.unansweredList.length
            })</div>
       <ol style="margin:0 0 6px 18px;">
         ${data.unansweredList
           .map((q) => `<li style="margin:6px 0;">${escapeHtml(q.prompt)}</li>`)
           .join("")}
       </ol>`
          : `<div style="font-weight:900; margin:10px 0; color:#137333;">No unanswered ✅</div>`;

        section.innerHTML = wrongHtml + unHtml;

        modal.appendChild(title);
        modal.appendChild(section);
        overlay.appendChild(modal);

        // click outside closes
        overlay.addEventListener("click", (e) => {
          if (e.target === overlay) overlay.remove();
        });

        // ESC closes
        document.addEventListener("keydown", function escClose(ev) {
          if (ev.key === "Escape") {
            overlay.remove();
            document.removeEventListener("keydown", escClose);
          }
        });

        document.body.appendChild(overlay);
      }

      function escapeHtml(str) {
        return String(str)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }

      function toggleInArray(arr, value) {
        const i = arr.indexOf(value);
        if (i === -1) arr.push(value);
        else arr.splice(i, 1);
      }

      function shuffleInPlace(arr) {
        for (let i = arr.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [arr[i], arr[j]] = [arr[j], arr[i]];
        }
      }

      function uniqueSorted(values) {
        return [...new Set(values.filter(Boolean))].sort((a, b) =>
          a.localeCompare(b)
        );
      }

      //   function getBankSubjects() {
      //     return uniqueSorted(QUESTIONS.map((q) => q.subject));
      //   }

      //   function getBankTopics(subject) {
      //     return uniqueSorted(
      //       QUESTIONS.filter((q) => !subject || q.subject === subject).map(
      //         (q) => q.topic
      //       )
      //     );
      //   }

      //   function getBankLectures(subject, topic) {
      //     return uniqueSorted(
      //       QUESTIONS.filter(
      //         (q) =>
      //           (!subject || q.subject === subject) &&
      //           (!topic || q.topic === topic)
      //       ).map((q) => q.lecture)
      //     );
      //   }

      function filterQuestions() {
        return QUESTIONS.filter((q) => {
          if (
            state.selectedSubjects.length &&
            !state.selectedSubjects.includes(q.subject)
          )
            return false;

        //   if (
        //     state.selectedTopics.length &&
        //     !state.selectedTopics.includes(q.topic)
        //   )
        //     return false;

          if (
            state.selectedLectures.length &&
            !state.selectedLectures.includes(q.lecture)
          )
            return false;

          return true;
        });
      }

      function setDisabled(btn, disabled) {
        btn.disabled = disabled;
        btn.classList.toggle("disabled", disabled);
      }

      function setChipContainer(containerEl, items, selectedArray, onToggle) {
        containerEl.innerHTML = "";

        items.forEach((val) => {
          const b = document.createElement("button");
          b.type = "button";
          b.className =
            "btn small" + (selectedArray.includes(val) ? " selected" : "");
          b.textContent = val;

          b.addEventListener("click", () => onToggle(val));

          containerEl.appendChild(b);
        });

        if (items.length === 0) {
          const span = document.createElement("div");
          span.className = "tiny";
          span.textContent = "(none)";
          containerEl.appendChild(span);
        }
      }

      function updateSelectionUI() {
        // SUBJECTS (always from full bank)
        const subjects = uniqueSorted(QUESTIONS.map((q) => q.subject));
        setChipContainer(
          els.subjectChips,
          subjects,
          state.selectedSubjects,
          (val) => {
            toggleInArray(state.selectedSubjects, val);

            // Reset dependent selections
            // state.selectedTopics = [];
            state.selectedLectures = [];

            updateSelectionUI();
          }
        );

        // TOPICS (filtered by selected subjects if any)
        // const topics = uniqueSorted(
        //   QUESTIONS.filter(
        //     (q) =>
        //       state.selectedSubjects.length === 0 ||
        //       state.selectedSubjects.includes(q.subject)
        //   ).map((q) => q.topic)
        // );

        // setChipContainer(
        //   els.topicChips,
        //   topics,
        //   state.selectedTopics,
        //   (val) => {
        //     toggleInArray(state.selectedTopics, val);
        //     state.selectedLectures = [];
        //     updateSelectionUI();
        //   }
        // );

        // LECTURES (filtered by subject + topic selections)
        const lectures = uniqueSorted(
          QUESTIONS.filter(
            (q) =>
              (state.selectedSubjects.length === 0 ||
                state.selectedSubjects.includes(q.subject)) 
                // &&
            //   (state.selectedTopics.length === 0 ||
            //     state.selectedTopics.includes(q.topic))
          ).map((q) => q.lecture)
        );

        setChipContainer(
          els.lectureChips,
          lectures,
          state.selectedLectures,
          (val) => {
            toggleInArray(state.selectedLectures, val);
            updateSelectionUI();
          }
        );

        const matches = filterQuestions();
        els.noMatchesWarn.style.display =
          matches.length === 0 ? "block" : "none";

        els.selectionSummary.textContent =
          `Subjects: ${state.selectedSubjects.length || "any"} • ` +
        //   `Topics: ${state.selectedTopics.length || "any"} • ` +
          `Lectures: ${state.selectedLectures.length || "any"} • ` +
          `Matches: ${matches.length}`;
      }

      function startQuiz() {
        const matches = filterQuestions();
        if (matches.length === 0) {
          els.noMatchesWarn.style.display = "block";
          return;
        }

        activeQuestions = matches.map((q) => ({ ...q })); // shallow copy
        shuffleInPlace(activeQuestions);

        state.checked = {};
        state.answers = {}; // NEW
        state.index = 0;
        state.total = activeQuestions.length;

        renderCurrentQuestion();
      }

      // =========================
      // 5) QUIZ RENDERING
      // =========================
      function updateCounters() {
        let correct = 0,
          wrong = 0,
          checked = 0;

        for (const q of activeQuestions) {
          const m = state.checked[q.id];
          if (!m) continue;
          checked++;
          if (m === "right") correct++;
          if (m === "wrong") wrong++;
        }

        els.correctCount.textContent = correct;
        els.wrongCount.textContent = wrong;
        els.checkedCount.textContent = checked;

        els.totalCount.textContent = state.total;
        els.totalCount2.textContent = state.total;
        els.posCount.textContent = state.total ? state.index + 1 : 0;

        const atStart = state.index === 0;
        const atEnd = state.index === state.total - 1;

        setDisabled(els.prevBtn, state.total === 0 || atStart);
        setDisabled(els.nextBtn, state.total === 0 || atEnd);
        setDisabled(els.checkBtn, state.total === 0);
        setDisabled(els.resetBtn, state.total === 0);
        setDisabled(els.shuffleBtn, state.total === 0);
        setDisabled(els.checkAllBtn, state.total === 0);
      }

      function renderEmptyState() {
        els.host.innerHTML = `
          <section class="q">
            <h2>Select a quiz above and click <strong>Start Quiz</strong>.</h2>
            <div class="tiny">Your question bank can be huge — this page will filter it by subject/lecture.</div>
          </section>
        `;
        updateCounters();
      }

      function renderCurrentQuestion() {
        if (!activeQuestions.length) {
          renderEmptyState();
          return;
        }

        const q = activeQuestions[state.index];
        const mark = state.checked[q.id] || null;

        let inputHtml = "";

        // Support a "truefalse" type as radio True/False
        const normalizedType = q.type === "truefalse" ? "single" : q.type;

        if (normalizedType === "single") {
          const choices =
            q.type === "truefalse" ? ["True", "False"] : q.choices;

          inputHtml = `
            <div class="choices">
              ${choices
                .map(
                  (c, i) => `
                <label class="choice">
                  <input type="radio" name="q-${q.id}" value="${i}">
                  <div><strong>${String.fromCharCode(
                    65 + i
                  )}.</strong> ${escapeHtml(c)}</div>
                </label>
              `
                )
                .join("")}
            </div>
          `;
        }

        if (normalizedType === "multi") {
          inputHtml = `
            <div class="choices">
              ${q.choices
                .map(
                  (c, i) => `
                <label class="choice">
                  <input type="checkbox" name="q-${q.id}" value="${i}">
                  <div><strong>${String.fromCharCode(
                    65 + i
                  )}.</strong> ${escapeHtml(c)}</div>
                </label>
              `
                )
                .join("")}
            </div>
          `;
        }

        if (normalizedType === "dropdown") {
          inputHtml = `
            <div class="row">
              <select data-qid="${q.id}" data-kind="dropdown">
                <option value="" selected disabled>Select one…</option>
                ${q.options
                  .map(
                    (opt) => `
                  <option value="${escapeHtml(opt)}">${escapeHtml(opt)}</option>
                `
                  )
                  .join("")}
              </select>
            </div>
          `;
        }

        if (normalizedType === "double") {
          inputHtml = `
            <div class="row">
              ${q.fields
                .map(
                  (f, fi) => `
                <div>
                  <div class="tiny" style="font-weight:900; margin:0 0 6px;">${escapeHtml(
                    f.label
                  )}</div>
                  <select data-qid="${
                    q.id
                  }" data-kind="double" data-field="${fi}">
                    <option value="" selected disabled>Select one…</option>
                    ${f.options
                      .map(
                        (opt) => `
                      <option value="${escapeHtml(opt)}">${escapeHtml(
                          opt
                        )}</option>
                    `
                      )
                      .join("")}
                  </select>
                </div>
              `
                )
                .join("")}
            </div>
          `;
        }

        const statusHtml = mark
          ? `<div class="status ${mark === "right" ? "good" : "bad"}">
               ${mark === "right" ? "Correct ✅" : "Wrong ❌"}
             </div>`
          : `<div class="status" style="color:var(--muted);">Not checked yet</div>`;

        // Explanation ONLY when correct
        const explanationHtml =
          mark === "right" && q.explanation
            ? `<div class="explain"><strong>Explanation:</strong> ${escapeHtml(
                q.explanation
              )}</div>`
            : "";

        const meta = `
          <div class="tiny" style="margin-top:10px;">
            <strong>${escapeHtml(q.subject || "")}</strong> •
            ${escapeHtml(q.lecture || "")}
          </div>
        `;

        els.host.innerHTML = `
          <section class="q" data-qid="${q.id}">
            <h2>${state.index + 1}. ${escapeHtml(q.prompt)}</h2>
            ${inputHtml}
            ${statusHtml}
            ${explanationHtml}
            ${meta}
          </section>
        `;

        restoreAnswerToUI();
        updateCounters();
      }

      function restoreAnswerToUI() {
        if (!activeQuestions.length) return;

        const q = activeQuestions[state.index];
        const section = els.host.querySelector("section[data-qid]");
        if (!section) return;

        const saved = state.answers[q.id];
        if (saved == null) return;

        const isTrueFalse = q.type === "truefalse";
        const normalizedType = isTrueFalse ? "single" : q.type;

        if (normalizedType === "single") {
          const input = section.querySelector(
            `input[name="q-${q.id}"][value="${saved}"]`
          );
          if (input) input.checked = true;
        }

        if (normalizedType === "multi" && Array.isArray(saved)) {
          saved.forEach((v) => {
            const input = section.querySelector(
              `input[name="q-${q.id}"][value="${v}"]`
            );
            if (input) input.checked = true;
          });
        }

        if (normalizedType === "dropdown") {
          const sel = section.querySelector(`select[data-kind="dropdown"]`);
          if (sel) sel.value = saved;
        }

        if (normalizedType === "double" && Array.isArray(saved)) {
          const sels = [
            ...section.querySelectorAll(`select[data-kind="double"]`),
          ].sort((a, b) => Number(a.dataset.field) - Number(b.dataset.field));
          sels.forEach((sel, i) => {
            sel.value = saved[i] || "";
          });
        }
      }

      function arraysEqualAsSets(a, b) {
        if (a.length !== b.length) return false;
        return [...a].sort().join("|") === [...b].sort().join("|");
      }

      function captureAnswerFromUI() {
        if (!activeQuestions.length) return;

        const q = activeQuestions[state.index];
        const section = els.host.querySelector("section[data-qid]");
        if (!section) return;

        const qid = q.id;
        const isTrueFalse = q.type === "truefalse";
        const normalizedType = isTrueFalse ? "single" : q.type;

        if (normalizedType === "single") {
          const picked = section.querySelector(
            `input[name="q-${qid}"]:checked`
          );
          state.answers[qid] = picked ? Number(picked.value) : null;
        }

        if (normalizedType === "multi") {
          const picked = [
            ...section.querySelectorAll(`input[name="q-${qid}"]:checked`),
          ].map((x) => Number(x.value));
          state.answers[qid] = picked; // array
        }

        if (normalizedType === "dropdown") {
          const sel = section.querySelector(`select[data-kind="dropdown"]`);
          state.answers[qid] = sel && sel.value ? sel.value : null;
        }

        if (normalizedType === "double") {
          const sels = [
            ...section.querySelectorAll(`select[data-kind="double"]`),
          ]
            .sort((a, b) => Number(a.dataset.field) - Number(b.dataset.field))
            .map((s) => s.value || "");
          state.answers[qid] = sels; // ["STATUTE","OFFENCE"]
        }
      }

      // Capture whenever user changes inputs on the current question
      els.host.addEventListener("change", captureAnswerFromUI);

      function checkCurrent() {
        if (!activeQuestions.length) return;

        const q = activeQuestions[state.index];
        const section = els.host.querySelector("section[data-qid]");
        const qid = q.id;

        // normalize truefalse
        const isTrueFalse = q.type === "truefalse";
        const normalizedType = isTrueFalse ? "single" : q.type;

        if (normalizedType === "single") {
          const picked = section.querySelector(
            `input[name="q-${qid}"]:checked`
          );
          if (!picked) return alert("Pick an answer first.");

          let isRight = false;

          if (isTrueFalse) {
            // choices: ["True","False"] => True=0, False=1
            const pickedBool = Number(picked.value) === 0;
            isRight = pickedBool === Boolean(q.answer);
          } else {
            isRight = Number(picked.value) === q.answerIndex;
          }

          state.checked[qid] = isRight ? "right" : "wrong";
          return renderCurrentQuestion();
        }

        if (normalizedType === "multi") {
          const picked = [
            ...section.querySelectorAll(`input[name="q-${qid}"]:checked`),
          ].map((x) => Number(x.value));
          if (picked.length === 0) return alert("Select your answers first.");
          if (q.answerIndices && picked.length !== q.answerIndices.length) {
            return alert(`Select exactly ${q.answerIndices.length} option(s).`);
          }
          const isRight = arraysEqualAsSets(picked, q.answerIndices);
          state.checked[qid] = isRight ? "right" : "wrong";
          return renderCurrentQuestion();
        }

        if (normalizedType === "dropdown") {
          const sel = section.querySelector(`select[data-kind="dropdown"]`);
          if (!sel || !sel.value) return alert("Select an option first.");
          const isRight = sel.value === q.answerValue;
          state.checked[qid] = isRight ? "right" : "wrong";
          return renderCurrentQuestion();
        }

        if (normalizedType === "double") {
          const sels = [
            ...section.querySelectorAll(`select[data-kind="double"]`),
          ];
          if (sels.some((s) => !s.value))
            return alert("Select an option for each dropdown first.");

          const picked = sels
            .sort((a, b) => Number(a.dataset.field) - Number(b.dataset.field))
            .map((s) => s.value);

          const isRight =
            picked[0] === q.answers[0] && picked[1] === q.answers[1];
          state.checked[qid] = isRight ? "right" : "wrong";
          return renderCurrentQuestion();
        }
      }

      function prev() {
        if (state.index === 0) return;
        state.index--;
        renderCurrentQuestion();
      }

      function next() {
        if (state.index >= state.total - 1) return;
        state.index++;
        renderCurrentQuestion();
      }

      function resetQuiz() {
        if (!activeQuestions.length) return;
        state.checked = {};
        state.answers = {}; // NEW
        state.index = 0;
        renderCurrentQuestion();
      }

      function shuffleQuiz() {
        if (!activeQuestions.length) return;
        state.checked = {};
        state.answers = {}; // NEW
        state.index = 0;
        shuffleInPlace(activeQuestions);
        renderCurrentQuestion();
      }

      function clearSelection() {
        state.selectedSubjects = [];
        // state.selectedTopics = [];
        state.selectedLectures = [];

        updateSelectionUI();

        activeQuestions = [];
        state.checked = {};
        state.answers = {}; // ✅ add this
        state.index = 0;
        state.total = 0;

        renderEmptyState();
      }

      // =========================
      // 6) WIRES
      // =========================
      els.checkBtn.addEventListener("click", checkCurrent);
      els.prevBtn.addEventListener("click", prev);
      els.nextBtn.addEventListener("click", next);
      els.resetBtn.addEventListener("click", resetQuiz);
      els.shuffleBtn.addEventListener("click", shuffleQuiz);
      els.checkAllBtn.addEventListener("click", checkAllAnswered);

      els.startBtn.addEventListener("click", startQuiz);
      els.clearSelectionBtn.addEventListener("click", clearSelection);

      document.addEventListener("keydown", (e) => {
        if (e.key === "ArrowLeft") prev();
        if (e.key === "ArrowRight") next();
        if (e.key === "Enter") checkCurrent();
      });

      // =========================
      // 7) INIT
      // =========================
      updateSelectionUI();
      renderEmptyState();
    </script>
  </body>
</html>
